comp = {
  'Eenheid': {

  },
  'MJVK Beheer BV': {
    Rekening: 'NL39INGB0006299856',
  },
  'Alicon Projects BV': {
    Rekening: 'NL33INGB0006299867',
  },
  'Alicon Systems BV': {
    Rekening: 'NL87INGB0006299865',
  }
};
jaren = {
  ' 2020': {},
  ' 2019': {},
  ' 2018': {},
  ' 2017': {},
  ' 2016': {},
  ' 2015': {},
  ' 2014': {},
  ' 2013': {},
}

rek = {
  NL39INGB0006299856: 'MJVK Beheer BV',
  NL33INGB0006299867: 'Alicon Projects BV',
  NL87INGB0006299865: 'Alicon Systems BV',
}

gb = {
	'ACTIVA': {
		'Immateriele vaste activa': {
			'Goodwill': { volgnr: 1111 },
			'Overige immateriele vaste activa': { volgnr: 1112 },
		},
		'Materiele vaste activa': {
			'Gebouwen en tereinen': { volgnr: 1121 },
			'Machines en installaties': { volgnr: 1122 },
			'Overige materiele vaste activa': { volgnr: 1123 },
		},
		'Financiele vaste activa': {
			'Deelnemingen': { volgnr: 1131 },
			'Langlopende vorderingen op groepsmaatschappijen': { volgnr: 1132 },
			'Langlopende vorderingen op groepsmaatschappijen': { volgnr: 1133 },
			'Langlopende vorderingen op particiapnten en maatschappijen waarin wordt deelgenomen': { volgnr: 1134 },
			'Overige financiele vaste activa': { volgnr: 1135 },
		},
		'Voorraden': {
			'Voorraden': { volgnr: 1141 },
			'Onderhanden werk': { volgnr: 1142 },
		},
		'Vorderingen': {
			'Vorderingen op handelsdebiteuren': { volgnr: 1151 },
			'Vordering omzetbelasting': { volgnr: 1152 },
			'Kortlopende vorderingen op groepsmaatschapijen': { volgnr: 1153 },
			'Kortlopende vorderingen op participanten en maatschappijen waarin wordt deelgenomen': { volgnr: 1154 },
      'Overige vorderingen': { volgnr: 1155 },
      'Overige vorderingen': { volgnr: 1156 },
		},
		'Effecten': {
			'Effecten': { volgnr: 1161 },
		},
		'Liquide middelen': {
			'Bank': { volgnr: 1171 },
			'Kas': { volgnr: 1172 },
			'Bank Sparen': { volgnr: 1173 },
			'Kruispost': { volgnr: 1174 },
		},
	},
	'PASSIVA': {
		'Ondernemingsvermogen': {
			'Gestort en opgevraagd kapitaal': { volgnr: 1211 },
			'Informeel kapitaal': { volgnr: 1222 },
			'Agio': { volgnr: 1223 },
			'Winstreserves': { volgnr: 1224 },
			'Egalisatiereserve': { volgnr: 1225 },
			'Herinvesteringsreserve': { volgnr: 1226 },
			'Belaste compartimeteringsreserve': { volgnr: 1227 },
			'Overige fiscale reserves': { volgnr: 1228 },
		},
		'Voorzieningen': {
			'Garantie voorzienigen': { volgnr: 1231 },
			'Stamrecht, lijfrente en pensioenvoorziening': { volgnr: 1232 },
			'Overige voorziening': { volgnr: 1233 },
		},
		'Langlopende schulden': {
			'Converteerbare leningen': { volgnr: 1241 },
			'Obligaties': { volgnr: 1242 },
			'Langlopende schulden aan groepsmaatschapijen': { volgnr: 1243 },
			'Langlopende schulden aan particiapnten en maatschappijen waarin wordt deelgenomen': { volgnr: 1244 },
			'Schulden aan kredietinstellingen': { volgnr: 1245 },
			'Overige langlopende schulden': { volgnr: 1246 },
		},
		'Kortlopende schulden': {
			'Schulden aan leveranciers en handelskredieten': { volgnr: 1251 },
			'Schuld omzetbelasting': { volgnr: 1252 },
			'Schuld loonheffing': { volgnr: 1255 },
			'Kortlopende schulden aan groepsmaatschappijen': { volgnr: 1253 },
			'Kortlopende schulden aan participanten en maatschappijen waarin wordt deelgenomen': { volgnr: 1254 },
			'Overige kortlopende schulden': { volgnr: 1256 },
		},
	},
	'Winst en Verlies': {
		'Resultaat na belastingen': {
			'Resultaat uit gewone bedrijfsuitvoering': {
				'Baten en Lasten': {
					'Baten': {
						'Opbrengsten': {
							'Nettoomzet': { volgnr: 2111 },
							'Wijziging in voorraden en onderhanden werk': { volgnr: 2112 },
							'Geactiveerde productie voor het eigen bedrijf': { volgnr: 2122 },
							'Overige opbrengsten': { volgnr: 2123 },
						}
					},
					'Lasten': {
						'Inkoopkosten, uitbesteed werk e.d': {
							'Inkoopprijs van de verkopen en kosten van grond en hulpstoffen': { volgnr: 2211 },
							'Kosten van uitbesteed werk en andere externe kosten': { volgnr: 2212 },
						},
						'Personeelskosten': {
							'Lonen en salarissen': { volgnr: 2221 },
							'Sociale lasten': { volgnr: 2222 },
							'Pensioenlasten': { volgnr: 2223 },
							'Overige personeelskosten': { volgnr: 2224 },
							'Ontvangen uitkeringen en subsidies': { volgnr: 2225 },
						},
						'Afschrijvingen': {
							'Goodwill': { volgnr: 2231 },
							'Overige immateriele vaste activa': { volgnr: 2232 },
							'Gebouwen en terreinen': { volgnr: 2233 },
							'Machines en installaties': { volgnr: 2234 },
							'Overige materiele vaste activa': { volgnr: 2235 },
						},
						'Waarde veranderingen': {
							'Overige waardeveranderingen van immateriele en materiele vaste activa': { volgnr: 2241 },
							'Bijzondere waardevermindering van vlottende activa': { volgnr: 2242 },
						},
						'Overige bedrijfskosten': {
							'Auto en transportkosten': { volgnr: 2251 },
							'Huisvestingskosten': { volgnr: 2252 },
							'Onderhoudskosten van overige materiele vaste activa': { volgnr: 2253 },
							'Verkoopkosten': { volgnr: 2254 },
							'Andere kosten': { volgnr: 2255 },
						},
					},
				},
				'Financiele baten en lasten': {
					'Opbrengsten van vorderingen op groepsmaatschapijen': { volgnr: 2261 },
					'Opbrengsten van vorderingen op participanten en maatschappijen waarin wordt deelgenomen': { volgnr: 2262 },
					'Opbrengsten van banktegoeden': { volgnr: 2263 },
					'Opbrengsten van overige vorderingen': { volgnr: 2264 },
					'Ontvangend dividend (niet van deelnemingen)': { volgnr: 2265 },
					'Kwijtscheldingswinst': { volgnr: 2266 },
					'Waardeverandering van vorderingen': { volgnr: 2267 },
					'Waardeverandering van effecten': { volgnr: 2268 },
					'Kosten van schulden aan groepsmaatschapijen': { volgnr: 2269 },
					'Kosten van schulden aan participanten en maatschapijen waarin wordt deelgenomen': { volgnr: 2270 },
					'Kosten van schulden, rentelasten en soortgelijke kosten': { volgnr: 2271 },
				},
			},
			'Resultaat uit deelnemingen': {
				'Resultaat uit deelnemingen': { volgnr: 2281 },
			},
			'Buitengewone resultaten': {
				'Buitengewone baten': {
					'Voordelen door ontvoeging dochtermaatschappij of beeindiging fiscale Eenheid': { volgnr: 2282 },
					'Boekwinst op activa': { volgnr: 2283 },
					'Overige buitengewone baten': { volgnr: 2284 },
				},
				'Buitengewone lasten': {
					'Afboekingen herinvesteringreserves op gekochte activa': { volgnr: 2291 },
					'Uitkeringen aan algemeen nut beoogde instellingen (ANBI)': { volgnr: 2292 },
					'Overige buitengewone lasten': { volgnr: 2293 },
				}
			},
			'Venootschapsbelasting': { volgnr: 3001 },
		},
	},
};
boekNrs = {};
boekTitel = {};
boekTitelNr = {};

strValue = (value) => {
  return value ? Number(value).toLocaleString('nl-NL', {minimumIntegerDigits: 1, maximumFractionDigits: 0}) : '';
}

addBoek = (boek, boekregel) => {
  boekregel = boekregel || boek.boek || boek;
  value = Number(boek.Bedrag);
  if (!balans[boek.Jaar]) return console.error(boek);
  let jaar = balans[boek.Jaar] = balans[boek.Jaar] || {};
  let bedrijf = jaar[boek.Bedrijf] = jaar[boek.Bedrijf] || {};
  let boekNR = bedrijf[boek.BoekNr] = bedrijf[boek.BoekNr] || {};
  if (isNaN(value)) console.error(value,boek,boekregel);
  jaar.Eenheid = jaar.Eenheid || {};
  jaar.Eenheid[boek.BoekNr] = jaar.Eenheid[boek.BoekNr] || { value: 0}
  jaar.Eenheid[boek.BoekNr].value += Number(value);
  boekNR.value += Number(value);
  boekNR.show = true;

  // console.log(boek.Jaar, boek.Bedrijf, boek.BoekNr);
  elBoek[boek.Jaar][boek.Bedrijf][boek.BoekNr].elH.style ='';
  //
  // var elTR = elBoek[boek.Jaar][boek.Bedrijf][boek.BoekNr].appendTag('TR');
  // elTR.appendTag('TD', (boek.Datum || boek.Jaar).substr(0,10));
  // var elTD = elTR.appendTag('TD');
  // if (boek.name) elTD.appendTag('A', {name:boek.name});
  // elTD.appendTag('A', [boekTitel[boek.BoekNr],boekregel.Post,boekregel.PostID, boek.Opmerking, boekregel.Relatie,boekregel.KasGiro,boekregel.BankDT, boekregel.BTWprocent, boekregel.Omschrijving, boekregel.FaktuurNR, boek.Omschrijving].filter(Boolean).join(','), {href: '#B' + boekregel.ID });
  // // elTD.appendTag('A', Object.values(boekregel).filter((val)=>{ if (val && typeof val != 'object') return val; }).join('; '), {href: '#B' + boekregel.ID });
  // var bedrag = Number(boek.Bedrag);
  // elTR.appendTag('TD', bedrag >= 0 ? bedrag.toLocaleString('nl-NL', {minimumIntegerDigits: 1, minimumFractionDigits: 2}) : '');
  // elTR.appendTag('TD', bedrag < 0 ? (-bedrag).toLocaleString('nl-NL', {minimumIntegerDigits: 1, minimumFractionDigits: 2}) : '');
  // return elTD;
}

AIM.extend({
  on:{
    init:()=>{
      balans = {};
      (goTable = function(obj) {
        for (let [name, child] of Object.entries(obj)) {
          if (child.volgnr) {
            boekNrs[child.volgnr] = child;
            boekTitel[child.volgnr] = name;
            boekTitelNr[name] = child.volgnr;
          } else {
            goTable(child);
          }
        }
      })(gb);

      content.appendTag('H1','BALANS');
      elBALANS = content.appendTag('TABLE',{className: 'balans'});
      content.appendTag('H1','BOEK STUKKEN');
      elBOEKSTUK = content.appendTag('TABLE',{className: 'boek'});
      content.appendTag('H1','BOEKING');
      elBoek = {};
      for (let [jaar, jaarObj] of Object.entries(jaren)) {
        jaar = jaar.trim();
        elBoek[jaar] = {};
        content.appendTag('H2', jaar);
        for (let [company, companyObj] of Object.entries(comp)) {
          content.appendTag('H3', company);
          elBoek[jaar][company] = content.appendTag('TABLE');
          for (let [boekTitel, boekNr] of Object.entries(boekTitelNr)) {
            // console.log(boekTitelNr);
            content.appendTag('A',{name: [jaar,company,boekNr].join()});
            var elH = content.appendTag('H4', [jaar,company,boekNr,boekTitel].join(), {style:'display:none;'});
            elBoek[jaar][company][boekNr] = content.appendTag('TABLE', {className:'boek'});
            elBoek[jaar][company][boekNr].elH = elH;

          }
        }
      }
      console.log('elBoek', elBoek);
      content.appendTag('H1','BANK');
      elBank = {};
      for (let [jaar, jaarObj] of Object.entries(jaren)) {
        jaar = jaar.trim();
        elBank[jaar] = {};
        content.appendTag('H2','JAAR');
        for (let [company, companyObj] of Object.entries(comp)) {
          content.appendTag('H3','company');
          elBank[jaar][company] = content.appendTag('TABLE');
        }
      }
      elROW = elBALANS.appendTag('TR');
      elROW.appendTag('TH', 'post');
      elROW.appendTag('TH', 'volgnr');
      for (let [jaar, jaarObj] of Object.entries(jaren)) {
        // elROW.appendTag('TH', jaar);
        for (let [company, companyObj] of Object.entries(comp)) {
          elROW.appendTag('TH', company + jaar);
        }
      };
      (goTable = function(obj, level) {
        for (let [name, child] of Object.entries(obj)) {
          var BoekNr = child.volgnr;
          // console.log(child.volgnr);
          var elROW = elBALANS.appendTag('TR', {className:'h' + level, style:'display:none;'});
          elROW.appendTag('TD', name, {className:'oms'});
          elROW.appendTag('TD', String(BoekNr || ''));
          for (let [jaar, jaarObj] of Object.entries(jaren)) {
            jaar = jaar.trim();
            balans[jaar] = balans[jaar] || {};
            // var el = elROW.appendTag('TD', {volgnr:String(child.volgnr)});
            elROW[jaar] = {};
            // if (BoekNr) {
            //   balans[jaar][String(BoekNr)] = {el : el, value: 0};
            // }
            for (let [company, companyObj] of Object.entries(comp)) {
              balans[jaar][company] = balans[jaar][company] || {};
              var el = elROW.appendTag('TD').appendTag('A');
              el.elROW = elROW;
              elROW[jaar][company] = el;
              // console.log(BoekNr);
              if (BoekNr) {
                el.href = '#' + [jaar,company,BoekNr].join();
                balans[jaar][company][BoekNr] = {el : el, value: 0};
              }
            };
          };
          if (!BoekNr) {
            elROW.className += ' sum';
            goTable(child,level+1);
          }
          // child.parent = obj;
          child.el = elROW;
        }
      })(gb, 1);
      AIM.http.request('balans.php',(event)=>{
        data = JSON.parse(event.target.responseText);
        console.log(data);
        data.boek.unshift({ID:0});
        for (var name in data) {
          window[name] = {};
          data[name].forEach((row)=>{
            window[name][row.ID] = row;
          });
        }
        for (let [ID, row] of Object.entries(regels)) {
          row.BoekingID = row.BoekingID || 0;
          boek[row.BoekingID] = boek[row.BoekingID] || {};
          // console.log(row.BoekingID, boek[row.BoekingID]);
          (boek[row.BoekingID].regels = boek[row.BoekingID].regels || []).push(row);
        }
        elULmain = elBALANS.appendTag('UL');
        var refID = 0;
        console.log('VERWERKEN BOEKINGEN');
        data.boek.forEach((B)=>{
          // let elTR = elBOEKSTUK.appendTag('TR');
          // elTR.appendTag('TD').appendTag('A', {name: 'B' + B.ID}).appendText(B.Datum);
          // elTD = elTR.appendTag('TD').appendTag('B', [B.ID, B.Omschrijving, B.FaktuurNR, B.KasGiro, B.BTWprocent, B.RelatieID && relatie[B.RelatieID] ? relatie[B.RelatieID].Relatie : '', B.BankDT].filter(Boolean).join('; '));
          // elTR.appendTag('TD', B.Bedrag >= 0 ? Number(B.Bedrag).toLocaleString('nl-NL', {minimumIntegerDigits: 1, minimumFractionDigits: 2}) : '');
          // elTR.appendTag('TD', B.Bedrag < 0 ? Number(-B.Bedrag).toLocaleString('nl-NL', {minimumIntegerDigits: 1, minimumFractionDigits: 2}) : '');
          if (B.regels) B.regels.forEach((R)=>{
            // let elTR = elBOEKSTUK.appendTag('TR');
            // elTR.appendTag('TD', R.Datum);
            // elTD = elTR.appendTag('TD').appendTag('A', [bedrijf[R.BedrijfID].Bedrijf,boekTitel[R.BoekNR],B.RelatieID && relatie[B.RelatieID] ? relatie[B.RelatieID].Relatie : '', R.Omschrijving].filter(Boolean).join('; '), {href: '#ref' + refID});
            // elTR.appendTag('TD', R.Bedrag >= 0 ? Number(R.Bedrag).toLocaleString('nl-NL', {minimumIntegerDigits: 1, minimumFractionDigits: 2}) : '');
            // elTR.appendTag('TD', R.Bedrag < 0 ? Number(-R.Bedrag).toLocaleString('nl-NL', {minimumIntegerDigits: 1, minimumFractionDigits: 2}) : '');
            addBoek({
              Jaar: R.Datum.substr(0,4),
              Bedrijf: bedrijf[R.BedrijfID].Bedrijf,
              BoekNr: R.BoekNR,
              Bedrag: R.Bedrag,
              Datum: R.Datum,
              Omschrijving: R.Omschrijving,
              name: 'ref' + refID,
            }, B);
            refID++;
          });
        });

        console.log('OMZETTEN');

        // Omzetten negatief balans naar andere zijde
        for (let [jaarName, jaar] of Object.entries(balans)) {
          for (let [companyName, companyData] of Object.entries(comp)) {
            // if (!balans[jaarName][company.Bedrijf]) continue;
            for (let [boekNr, titel] of Object.entries(boekTitel)) {
              if (boekNr < 1200 && !['1171','1172'].includes(boekNr)) {
                // console.log(company.Bedrijf, balans[jaarName][company.Bedrijf], boekNr);
                var boekActiva = balans[jaarName][companyName][boekNr] = balans[jaarName][companyName][boekNr] || {value: 0};
                var boekPassiva = balans[jaarName][companyName][Number(boekNr) + 100] = balans[jaarName][companyName][Number(boekNr) + 100] || {value: 0};
                var value = - Number(boekActiva.value) + Number(boekPassiva.value);
                if (value < 0) {
                  // console.log(jaarName, companyName, boekNr, value);
                  boekActiva.value = - value;
                  boekPassiva.value = 0;
                } else {
                  boekActiva.value = 0;
                  boekPassiva.value = value;
                }
              }
            }
          }
        }

        console.log('TOTALEN');

        // PLAATS BEDRAGEN IN OVERZICHT BALANS
        // console.log ('GB', balans);
        (goTable1 = function(obj, level) {
          obj.jaar = {};
          for (let [name, child] of Object.entries(obj)) {
            if (['el','jaar'].includes(name)) return;
            let boekNr = child.volgnr;
            console.log(boekNr);
            if (!boekNr) {
              goTable1(child, level + 1);
            }
            for (let [jaar, jaarObj] of Object.entries(jaren)) {
              jaar = jaar.trim();
              obj.jaar[jaar] = obj.jaar[jaar] || {};
              for (let [company, companyObj] of Object.entries(comp)) {
                var value = boekNr ? balans[jaar][company][String(boekNr)].value : child.jaar[jaar][company];
                obj.jaar[jaar][company] = obj.jaar[jaar][company] || 0;
                obj.jaar[jaar][company] += value;
                child.el[jaar][company].innerText = strValue(value);
                if (child.el[jaar][company].innerText || (balans[jaar][company][String(boekNr)] && balans[jaar][company][String(boekNr)].show)) {
                  child.el[jaar][company].innerText = child.el[jaar][company].innerText || '0';
                  child.el[jaar][company].elROW.style.display='';
                }
              };
            };
          }
        })(gb, 1);

        console.log('GEREED');

      });
    }
  }
})
